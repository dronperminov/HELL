<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Статистика с {{start_date}} по {{end_date}} | HELL</title>
    <link rel="stylesheet" type="text/css" href="/styles/styles.css">
    <link rel="stylesheet" type="text/css" href="/styles/inputs.css">
    <link rel="stylesheet" type="text/css" href="/styles/plot.css">
    <link rel="stylesheet" type="text/css" href="/styles/statistic.css">
    <link rel="stylesheet" href="/styles/font-awesome.min.css">
</head>
<body>
    {% include "menu.html" %}
    <h1>Статистика</h1>

    <div class="statistic-parameters">
        <div class="statistic-period">
            <select id="period" onchange="UpdateStatisticParameters()">
                <option value="today"{% if period == "today" %} selected{% endif %}>сегодня</option>
                <option value="yesterday"{% if period == "yesterday" %} selected{% endif %}>вчера</option>
                <option value="week"{% if period == "week" or not period %} selected{% endif %}>текущая неделя</option>
                <option value="last-week"{% if period == "last-week" %} selected{% endif %}>прошлая неделя</option>
                <option value="last-14days"{% if period == "last-14days" %} selected{% endif %}>последние 14 дней</option>
                <option value="period"{% if period == "period" %} selected{% endif %}>период</option>
            </select>

            <div class="statistic-period-input{% if period != "period" %} no-display{% endif %}" id="dates">
                <div class="statistic-period-input-cell">с</div>
                <div class="statistic-period-input-cell"><input type="text" value="{{start_date}}" id="start-date"></div>
                <div class="statistic-period-input-cell">по</div>
                <div class="statistic-period-input-cell"><input type="text" value="{{end_date}}" id="end-date"></div>
            </div>
        </div>
        <div class="statistic-button">
            <button onclick="ChangeStatisticParameters()">Показать</button>
        </div>
    </div>

    <div class="statistic-showed">
        Показана информация за
        {% if period == "today" %}сегодня ({{start_date}})
        {% elif period == "yesterday" %}вчера ({{start_date}})
        {% elif period == "week" or not period %}текущую неделю (с {{start_date}} по {{end_date}})
        {% elif period == "last-week" %}прошлую неделю (с {{start_date}} по {{end_date}})
        {% elif period == "last-14days" %}последние 14 дней (с {{start_date}} по {{end_date}})
        {% else %}период с {{start_date}} по {{end_date}}{% endif %}
    </div>

    <div class="statistic">
        <div class="h-scrollable">
            <svg id="statistic-chart"></svg>
        </div>

        <div class="statistic-info">
            <div class="statistic-header">Усреднённые результаты</div>
            <div class="statistic-row"><span class="plot-circle bar-color1"></span> Белки: <span id="proteins"></span></div>
            <div class="statistic-row"><span class="plot-circle bar-color2"></span> Жиры: <span id="fats"></span></div>
            <div class="statistic-row"><span class="plot-circle bar-color3"></span> Углеводы: <span id="carbohydrates"></span></div>
            <div class="statistic-row">Калории: <span id="energy"></span></div>
        </div>
    </div>

    <script src="/js/chart.js"></script>
    <script>
        let statisticData = [
            {% for date in dates_range %}{ {% for key in statistic[date] %}"{{key}}": {{statistic[date][key]}}, {% endfor %}"date": "{{date}}"},
            {% endfor %}
        ]

        function GetMaxEnergy() {
            let maxEnergy = 0

            for (let data of statisticData)
                maxEnergy = Math.max(maxEnergy, data["energy"])

            if (maxEnergy == 0)
                return 1

            return maxEnergy
        }

        function MakeLabelText(x, y, date, baseline = "middle") {
            let text = document.createElementNS('http://www.w3.org/2000/svg', "text")
            text.textContent = date
            text.setAttribute("x", x)
            text.setAttribute("y", y)
            text.setAttribute("alignment-baseline", baseline)
            text.setAttribute("text-anchor", "middle")
            text.setAttribute("class", "label")
            return text
        }

        function MakeBar(svg, x, y, rectWidth, rectHeight, total, data, keys, gap = 2) {
            if (rectHeight == 0)
                return []

            let coords = []

            for (let i = 0; i < keys.length; i++) {
                let rect = document.createElementNS('http://www.w3.org/2000/svg', "rect")
                let partHeight = data[keys[i]] / total * rectHeight

                rect.setAttribute("x", x)
                rect.setAttribute("y", y)
                rect.setAttribute("width", rectWidth)
                rect.setAttribute("height", partHeight)
                rect.setAttribute("class", `bar-color${i + 1}`)
                svg.appendChild(rect)

                if (i > 0)
                    coords.push(y)

                y += partHeight
            }

            for (let coord of coords) {
                let path = document.createElementNS('http://www.w3.org/2000/svg', "path")
                path.setAttribute("d", `M${x} ${coord} l${rectWidth} 0`)
                path.setAttribute("stroke-width", gap)
                path.setAttribute("class", "bar-divider")
                svg.appendChild(path)
            }
        }

        function PrintInfo(keys, totalStatistic, count) {
            let totalKeys = 0

            for (let key of keys)
                totalKeys += totalStatistic[key]

            let percents = 0

            for (let i = 0; i < keys.length; i++) {
                let key = keys[i]
                let span = document.getElementById(key)
                let average = Math.round(totalStatistic[key] / count * 2) / 2
                let averagePercent = Math.round(totalStatistic[key] / totalKeys * 100)
                percents += averagePercent

                if (percents > 100)
                    averagePercent = Math.round(averagePercent + 100 - percents)

                span.innerText = `${average} г`

                if (totalKeys > 0)
                    span.innerText += ` (${averagePercent}%)`
            }

            let span = document.getElementById("energy")
            span.innerText = `${Math.round(totalStatistic["energy"] / count * 2) / 2} ккал`
        }

        function PlotBarStatistic(svg, keys, padding = 5, topPadding = 18, bottomPadding = 10, minRectWidth=42, maxRectWidth = 60) {
            let width = svg.clientWidth
            let height = svg.clientHeight

            let rectWidth = width / statisticData.length - padding

            if (rectWidth < minRectWidth) {
                rectWidth = minRectWidth
                width = (rectWidth + padding) * statisticData.length
                svg.style.width = `${width}px`
            }
            else if (rectWidth > maxRectWidth) {
                rectWidth = maxRectWidth
            }

            svg.setAttribute("viewBox", `0 0 ${width} ${height}`)

            let maxEnergy = GetMaxEnergy()
            let totalStatistic = {"energy": 0}
            let count = 0

            for (let key of keys)
                totalStatistic[key] = 0

            for (let i = 0; i < statisticData.length; i++) {
                let total = 0

                for (let key of keys) {
                    total += statisticData[i][key]
                    totalStatistic[key] += statisticData[i][key]
                }

                totalStatistic["energy"] += statisticData[i]["energy"]

                if (statisticData[i]["energy"] > 0)
                    count++

                let rectHeight = statisticData[i]["energy"] / maxEnergy * (height - topPadding - bottomPadding)
                let x = padding / 2 + i * (padding + rectWidth)
                let y = height - bottomPadding - rectHeight

                MakeBar(svg, x, y, rectWidth, rectHeight, total, statisticData[i], keys)

                svg.appendChild(MakeLabelText(x + rectWidth / 2, height - bottomPadding / 2, statisticData[i]["date"]))
                svg.appendChild(MakeLabelText(x + rectWidth / 2, y - 8, `${statisticData[i]["energy"]}`, "top"))
                svg.appendChild(MakeLabelText(x + rectWidth / 2, y - 2, "ккал", "top"))
            }

            PrintInfo(keys, totalStatistic, Math.max(count, 1))
        }

        function PlotDonutStatistic(svg, keys) {
            PrintInfo(keys, statisticData[0], 1)

            if (statisticData[0]["energy"] == 0) {
                svg.style.display = "none"
                return
            }

            svg.setAttribute("viewBox", "-50 -50 100 100")
            let chart = new Chart()
            let values = keys.map((key) => statisticData[0][key])
            chart.Plot(svg, values)
        }

        function PlotStatistic() {
            let keys = ["proteins", "fats", "carbohydrates"]
            let svg = document.getElementById("statistic-chart")

            if (statisticData.length == 1) {
                PlotDonutStatistic(svg, keys)
            }
            else {
                PlotBarStatistic(svg, keys)
            }
        }

        function UpdateStatisticParameters() {
            let period = document.getElementById("period").value
            let dates = document.getElementById("dates")

            if (period == "period") {
                dates.classList.remove("no-display")
            }
            else {
                dates.classList.add("no-display")
            }
        }

        function ValidateDate(day, month, year) {
            let days = new Date(year, month, 0).getDate()
            return day >= 1 && day <= days && month >= 1 && month <= 12
        }

        function ParseDate(value) {
            let today = new Date()
            let year = today.getFullYear()
            let month = today.getMonth() + 1

            let match = /^(?<day>\d\d?).(?<month>\d\d?).(?<year>\d\d\d\d)$/g.exec(value)
            if (match && ValidateDate(match.groups.day, match.groups.month, match.groups.year))
                return `${match.groups.day.padStart(2, '0')}.${match.groups.month.padStart(2, '0')}.${match.groups.year}`

            match = /^(?<day>\d\d?).(?<month>\d\d?)$/g.exec(value)
            if (match && ValidateDate(match.groups.day, match.groups.month, year))
                return `${match.groups.day.padStart(2, '0')}.${match.groups.month.padStart(2, '0')}.${year}`

            match = /^(?<day>\d\d?)$/g.exec(value)
            if (match && ValidateDate(match.groups.day, month, year))
                return `${match.groups.day.padStart(2, '0')}.${month.toString().padStart(2, '0')}.${year}`

            return null
        }

        function ValidateInterval(startDate, endDate) {
            let start = startDate.split('.').reverse().join('.')
            let end = endDate.split('.').reverse().join('.')
            return start <= end
        }

        function ChangeStatisticParameters() {
            let period = document.getElementById("period").value

            if (period == "period") {
                let startDateBox = document.getElementById("start-date")
                let endDateBox = document.getElementById("end-date")

                let startDate = ParseDate(startDateBox.value)
                let endDate = ParseDate(endDateBox.value)

                if (startDate == null) {
                    alert("Введена некорректная дата начала")
                    startDateBox.focus()
                    return
                }

                if (endDate == null) {
                    alert("Введена некорректная дата начала")
                    endDateBox.focus()
                    return
                }

                if (!ValidateInterval(startDate, endDate)) {
                    alert("Введён некорректный интервал: дата начала должна быть не больше конечной")
                    startDateBox.focus()
                    return
                }

                period = `${startDate}-${endDate}`
            }

            location.href = `/statistic?period=${period}`
        }

        PlotStatistic()
    </script>
</body>
</html>
