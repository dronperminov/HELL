<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>{% if date and meal_type %}{{date}}. Добавление еды на {{names[meal_type]}}{% else %}Коллекция продуктов{% endif %} | HELL</title>

    <link rel="stylesheet" type="text/css" href="/styles/styles.css">
    <link rel="stylesheet" type="text/css" href="/styles/inputs.css">
    <link rel="stylesheet" type="text/css" href="/styles/food-collection.css?v=3">
    <link rel="stylesheet" type="text/css" href="/styles/portion-edit.css">
    <link rel="stylesheet" href="/styles/font-awesome.min.css">
</head>
<body>
    {% include "menu.html" %}
    <h1>{% if date and meal_type %}{% if meal_type in names %}{{names[meal_type]}}{% else %}{{meal_type.title()}}{% endif %} {{date}}{% else %}Продукты{% endif %}</h1>

    <form class="food-search" method="get" action="{% if date and meal_type %}/add-meal/{{date}}/{{meal_type}}{% else %}/food-collection{% endif %}">
        <div class="food-search-clear{%if not query %} no-display{% endif %}" id="food-query-clear" onclick="ClearQuery()">
            <span class="fa fa-times">
        </div>

        <div class="food-search-input">
            <input type="text" name="food_query" id="food-query" oninput="UpdateClearQuery()" class="search-input" placeholder="Введите название продукта" {% if query %}value="{{query}}"{% endif %}>
        </div>

        <div class="food-search-button">
            <button type="submit">Найти</button>
        </div>
    </form>

    <div class="food-collection">
        {% if food_items == [] %}
            {% if query %}
                <div class="food-search-results">
                    <p>По запросу <i>"{{query}}"</i> продуктов не найдено...</p>
                    <p>Если Вы уверены, что продукт должен быть, нажмите кнопку ниже:</p>
                </div>
            {% endif %}
        {% else %}
            {% for food_item in food_items %}
            <div class="food-item" id="{{food_item._id}}">
                <div class="food-data" onclick="ClickFoodItem('{{food_item._id}}')">
                    <div class="food-name">{{food_item.name}}</div>
                    <div class="food-description">{{food_item.description}}</div>
                    <div class="food-info">
                        <div class="food-info-cell food-energy">{{food_item.energy}} ккал / {{food_item.portion}}</div>
                        <div class="food-info-cell food-fats">Ж{{food_item.fats}} г</div>
                        <div class="food-info-cell food-proteins">Б{{food_item.proteins}} г</div>
                        <div class="food-info-cell food-carbohydrates">У{{food_item.carbohydrates}} г</div>
                    </div>
                </div>

                {% if date and meal_type %}
                <div class="food-portion-edit no-display" data-default-unit="{{food_item.default_unit}}" data-default-value="{{food_item.default_value}}">
                    <div class="food-portion-text">Редактирование порции:</div>
                    <div class="food-portion-control">
                        <div class="food-portion-size">
                            <input id="{{food_item._id}}-portion-size" type="number" value="{{food_item.default_value}}">
                        </div>

                        <div class="food-portion-unit">
                            <select id="{{food_item._id}}-portion-unit">
                                {% for unit in food_item.conversions %}
                                <option value="{{unit}}" {% if food_item.default_unit == unit %}selected{% endif %}>{{unit}}</option>
                                {% endfor %}
                            </select>
                        </div>

                        <div class="food-portion-change">
                            <button onclick="AddMeal('{{date}}', '{{meal_type}}', '{{food_item._id}}')">
                                <span class="fa fa-plus"></span>{{food_item.test}}
                            </button>
                        </div>
                    </div>
                </div>
                {% endif %}
            </div>
            {% endfor %}
        {% endif %}
        </div>

        <div class="add-food">
            <button onclick="location.href='/add-food?{% if query %}food_query={{query.replace("'", "\\'")}}&{% endif %}{% if date and meal_type %}date={{date}}&meal_type={{meal_type}}{% endif %}';">Добавить новый продукт</button>
        </div>
    </div>

    <script src="/js/forms.js"></script>
    <script>
        function ClearQuery() {
            let query = document.getElementById("food-query")
            let clear = document.getElementById("food-query-clear")
            query.value = ""
            clear.classList.add("no-display")
        }

        function UpdateClearQuery() {
            let query = document.getElementById("food-query")
            let clear = document.getElementById("food-query-clear")

            if (query.value.length > 0)
                clear.classList.remove("no-display")
            else
                clear.classList.add("no-display")
        }

        function EndEditPortions(ignoreEdit = null) {
            let foodEdits = document.getElementsByClassName('food-portion-edit')

            for (let foodEdit of foodEdits) {
                if (foodEdit === ignoreEdit)
                    continue

                foodEdit.classList.add('no-display')
                foodEdit.parentNode.classList.remove('food-item-colored')
            }
        }

        function ClickFoodItem(foodId) {
        {% if date and meal_type %}
            let foodItem = document.getElementById(foodId)
            let portionEdit = foodItem.getElementsByClassName('food-portion-edit')[0]
            EndEditPortions(portionEdit)
            portionEdit.classList.toggle('no-display')
            foodItem.classList.toggle('food-item-colored')

            let portionSize = document.getElementById(`${foodId}-portion-size`)
            let portionUnit = document.getElementById(`${foodId}-portion-unit`)
            portionSize.value = portionEdit.getAttribute("data-default-value")
            portionUnit.value = portionEdit.getAttribute("data-default-unit")
            portionSize.focus()
            portionSize.select()
        {% else %}
            location.href = `/edit-food/${foodId}{% if query %}?food_query={{query.replace("'", "\\'")}}{% endif %}`
        {% endif %}
        }

        {% if date and meal_type %}
        function AddMeal(date, mealType, foodId) {
            let portionSize = document.getElementById(`${foodId}-portion-size`)
            let portionUnit = document.getElementById(`${foodId}-portion-unit`)

            if (!IsPositiveReal(portionSize.value)) {
                portionSize.focus()
                portionSize.select()
                alert("Размер порции введён некорректно")
                return
            }

            let data = {
                date: date,
                meal_type: mealType,
                food_id: foodId,
                portion_size: portionSize.value,
                portion_unit: portionUnit.value
            }

            SendRequest("/add-meal", data).then((response) => {
                if (response.status != "ok") {
                    alert("Не удалось добавить продукт")
                    return
                }

                location.href = `/diary?date={{date}}`
            })
        }
        {% endif %}
    </script>
</body>
</html>
